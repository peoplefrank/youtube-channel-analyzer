<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supercharged YouTube Channel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
            margin: 20px auto;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }
        .message-box.error { background-color: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .message-box.info { background-color: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        .message-box.success { background-color: #d1fae5; color: #059669; border: 1px solid #6ee7b7; }
        .stat-card {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .video-card {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .video-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .live-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stat-update {
            transition: all 0.2s ease-in-out;
        }
        .channel-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        .channel-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            object-fit: cover;
        }
        .fetch-more-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        .video-thumbnail {
            width: 100%;
            height: auto;
            border-radius: 6px;
            aspect-ratio: 16/9;
            object-fit: cover;
            margin-bottom: 12px;
        }
        .fallback-thumbnail {
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 14px;
        }

        /* --- Updated Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        #videoModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        #videoModal.modal-active {
            opacity: 1;
            pointer-events: auto;
        }
        
        #videoModal > div {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        
        #videoModal.modal-active > div {
            transform: scale(1);
        }
        
        .modal-open {
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            .channel-banner {
                height: 150px;
            }
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            .grid-cols-3, .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            .flex-col-sm {
                flex-direction: column;
            }
        }
        
        /* Animation for stat updates */
        @keyframes highlight {
            0% { background-color: rgba(74, 222, 128, 0.3); }
            100% { background-color: transparent; }
        }
        .highlight-update {
            animation: highlight 1.5s ease-out;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="flex justify-center py-8">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Supercharged YouTube Dashboard</h1>
        <p class="text-center text-gray-500 mb-8">Get detailed analytics, live stats & interactive graphs for any YouTube channel.</p>

        <div class="mb-6">
            <label for="channelInput" class="block text-gray-700 text-sm font-medium mb-2">Enter YouTube Channel ID, URL, or @handle:</label>
            <div class="relative">
                <input type="text" id="channelInput" placeholder="e.g., UC_x5XG1OV2P6wRIMAn-HGwA or @MrBeast"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="clearInputBtn" class="absolute right-3 top-2 text-gray-400 hover:text-gray-600" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Tip: Find channel ID in YouTube URL after /channel/ or /c/</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="analyzeButton" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md flex items-center justify-center gap-2">
                <span id="analyzeButtonText">üöÄ Analyze Channel</span>
                <span id="analyzeButtonLoader" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
            <button id="downloadPdfButton" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md flex items-center justify-center gap-2" style="display: none;">
                <span id="downloadPdfButtonText">üìÑ Download as PDF</span>
                <span id="downloadPdfButtonLoader" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>

        <div id="fetchMoreContainer" class="fetch-more-container">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="videoCountInput" class="block text-gray-700 text-sm font-medium mb-2">Fetch more videos (max 500):</label>
                    <input type="number" id="videoCountInput" min="1" max="500" value="50" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="fetchMoreButton" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 shadow-md mt-auto flex items-center justify-center gap-2">
                    <span id="fetchMoreButtonText">üîç Fetch Videos</span>
                    <span id="fetchMoreButtonLoader" class="hidden">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>

        <div id="messageBox" class="message-box"></div>
        <div id="loadingSpinner" class="loading-spinner"></div>

        <div id="resultsArea" class="hidden space-y-8 mt-8">
            <img id="channelBanner" class="channel-banner" alt="Channel Banner" onerror="this.style.display='none'"/>
            <div class="flex items-center gap-4 mb-4">
                <img id="channelLogo" class="channel-avatar hidden" alt="Channel Logo" onerror="this.src='https://www.gstatic.com/youtube/img/originals/promo/ytr-logo-for-search_160x160.png'"/>
                <div>
                    <h2 id="channelTitle" class="text-xl font-bold"></h2>
                    <p id="channelDesc" class="text-sm text-gray-600 line-clamp-2"></p>
                </div>
            </div>

            <div id="channelStatsContainer">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Channel Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat-card">
                        <div id="subLiveIndicator" class="live-indicator hidden">LIVE</div>
                        <p class="text-gray-500 text-sm font-medium">Subscribers</p>
                        <p id="subscriberCount" class="text-2xl font-bold text-gray-800 stat-update">-</p>
                        <p id="subscriberChange" class="text-xs text-gray-500">-</p>
                    </div>
                    <div class="stat-card">
                        <div id="viewLiveIndicator" class="live-indicator hidden">LIVE</div>
                        <p class="text-gray-500 text-sm font-medium">Total Views</p>
                        <p id="totalViews" class="text-2xl font-bold text-gray-800 stat-update">-</p>
                        <p id="viewChange" class="text-xs text-gray-500">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-gray-500 text-sm font-medium">Total Videos</p>
                        <p id="totalVideos" class="text-2xl font-bold text-gray-800">-</p>
                    </div>
                </div>
            </div>

            <div id="extendedStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8">
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Created On</p>
                    <p id="creationDate" class="text-lg font-bold text-gray-800">-</p>
                    <p id="channelAge" class="text-xs text-gray-500">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Country</p>
                    <p id="channelLocation" class="text-lg text-gray-800">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Verified</p>
                    <p id="verifiedStatus" class="text-lg text-blue-600">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Monetized</p>
                    <p id="monetizationStatus" class="text-lg text-green-600">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Kids Content</p>
                    <p id="isKidsContent" class="text-lg text-red-600">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Category</p>
                    <p id="channelCategory" class="text-lg text-gray-800">-</p>
                </div>
                <div class="stat-card col-span-full">
                    <p class="text-gray-500 text-sm font-medium">Tags</p>
                    <div id="channelTags" class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded-full">No tags</span>
                    </div>
                </div>
            </div>

            <div id="revenueStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-8">
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Avg Views / Video</p>
                    <p id="avgViewsPerVideo" class="text-lg text-gray-800">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Avg Views / Month</p>
                    <p id="avgViewsPerMonth" class="text-lg text-gray-800">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Upload Frequency</p>
                    <p id="uploadFrequency" class="text-lg text-gray-800">-</p>
                </div>
                <div class="stat-card">
                    <p class="text-gray-500 text-sm font-medium">Est. Revenue (RPM $0.5‚Äì$20)</p>
                    <p id="revenueRange" class="text-lg text-gray-800">-</p>
                </div>
            </div>

            <div id="graphsContainer">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Performance Graphs</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold text-center mb-2">Monthly Upload Cadence</h3>
                        <div class="relative h-64">
                            <canvas id="publishFrequencyChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-center mb-2">Recent Video Performance</h3>
                        <div class="relative h-64">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-center mb-2">Views vs. Engagement</h3>
                    <div class="relative h-64">
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="videoListContainer">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Latest Videos</h2>
                    <p id="videoCountDisplay" class="text-gray-500">Showing 0 videos</p>
                </div>
                <div id="videoCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Video cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Updated Video Modal Structure -->
    <div id="modalOverlay" class="modal-overlay"></div>
    <div id="videoModal" class="fixed inset-0 flex items-center justify-center p-4 z-[1000] opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl relative w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-transform duration-300 scale-95">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl font-bold leading-none">√ó</button>
            <div class="p-6">
                <div class="relative mb-4">
                    <img id="modalVideoThumbnail" src="" alt="Video Thumbnail" class="w-full rounded-md aspect-video object-cover" onerror="this.src='https://placehold.co/800x450/e0e0e0/ffffff?text=Thumbnail+Error'">
                    <a id="modalWatchOnYoutubeBtn" href="#" target="_blank" rel="noopener noreferrer" class="absolute top-2 right-2 bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700 transition-colors">
                        Watch on YouTube
                    </a>
                </div>
                <h3 id="modalVideoTitle" class="text-xl font-bold text-gray-800 mb-2"></h3>
                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-4">
                    <p><span id="modalVideoViews" class="font-semibold"></span> Views</p>
                    <p><span id="modalVideoLikes" class="font-semibold"></span> Likes</p>
                    <p><span id="modalVideoComments" class="font-semibold"></span> Comments</p>
                    <p><span id="modalVideoDuration" class="font-semibold"></span></p>
                    <p class="ml-auto">Published: <span id="modalVideoPublishedAt" class="font-semibold"></span></p>
                </div>
                <p id="modalVideoDescription" class="text-gray-700 text-sm max-h-40 overflow-y-auto custom-scrollbar pr-2"></p>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const encryptedParts = [
            "QUl6YVN5QmZTaW5TRUtN",        
            "NVNQNFE5bHZOU0djRQ==",       
            "R2JEb0tIWTdDcmc="             
        ];

        const YOUTUBE_API_KEY = encryptedParts.map(atob).join('');
    
        const elements = {
            channelInput: document.getElementById('channelInput'),
            clearInputBtn: document.getElementById('clearInputBtn'),
            analyzeButton: document.getElementById('analyzeButton'),
            analyzeButtonText: document.getElementById('analyzeButtonText'),
            analyzeButtonLoader: document.getElementById('analyzeButtonLoader'),
            downloadPdfButton: document.getElementById('downloadPdfButton'),
            downloadPdfButtonText: document.getElementById('downloadPdfButtonText'),
            downloadPdfButtonLoader: document.getElementById('downloadPdfButtonLoader'),
            resultsArea: document.getElementById('resultsArea'),
            videoCards: document.getElementById('videoCards'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            messageBox: document.getElementById('messageBox'),
            subscriberCount: document.getElementById('subscriberCount'),
            subscriberChange: document.getElementById('subscriberChange'),
            totalViews: document.getElementById('totalViews'),
            viewChange: document.getElementById('viewChange'),
            totalVideos: document.getElementById('totalVideos'),
            channelBanner: document.getElementById('channelBanner'),
            channelLogo: document.getElementById('channelLogo'),
            channelTitle: document.getElementById('channelTitle'),
            channelDesc: document.getElementById('channelDesc'),
            creationDate: document.getElementById('creationDate'),
            channelAge: document.getElementById('channelAge'),
            channelLocation: document.getElementById('channelLocation'),
            verifiedStatus: document.getElementById('verifiedStatus'),
            monetizationStatus: document.getElementById('monetizationStatus'),
            isKidsContent: document.getElementById('isKidsContent'),
            channelCategory: document.getElementById('channelCategory'),
            channelTags: document.getElementById('channelTags'),
            avgViewsPerVideo: document.getElementById('avgViewsPerVideo'),
            avgViewsPerMonth: document.getElementById('avgViewsPerMonth'),
            uploadFrequency: document.getElementById('uploadFrequency'),
            revenueRange: document.getElementById('revenueRange'),
            subLiveIndicator: document.getElementById('subLiveIndicator'),
            viewLiveIndicator: document.getElementById('viewLiveIndicator'),
            fetchMoreContainer: document.getElementById('fetchMoreContainer'),
            fetchMoreButton: document.getElementById('fetchMoreButton'),
            fetchMoreButtonText: document.getElementById('fetchMoreButtonText'),
            fetchMoreButtonLoader: document.getElementById('fetchMoreButtonLoader'),
            videoCountInput: document.getElementById('videoCountInput'),
            videoCountDisplay: document.getElementById('videoCountDisplay'),
            modalOverlay: document.getElementById('modalOverlay'),
            videoModal: document.getElementById('videoModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            modalVideoThumbnail: document.getElementById('modalVideoThumbnail'),
            modalWatchOnYoutubeBtn: document.getElementById('modalWatchOnYoutubeBtn'),
            modalVideoTitle: document.getElementById('modalVideoTitle'),
            modalVideoViews: document.getElementById('modalVideoViews'),
            modalVideoLikes: document.getElementById('modalVideoLikes'),
            modalVideoComments: document.getElementById('modalVideoComments'),
            modalVideoDuration: document.getElementById('modalVideoDuration'),
            modalVideoPublishedAt: document.getElementById('modalVideoPublishedAt'),
            modalVideoDescription: document.getElementById('modalVideoDescription')
        };

        let allVideosData = [];
        let channelDataStore = {};
        let charts = {
            publishFrequencyChart: null,
            performanceChart: null,
            engagementChart: null
        };
        let liveInterval;
        let currentChannelId = '';
        let uploadsPlaylistId = '';
        let previousStats = {
            subscriberCount: 0,
            viewCount: 0
        };

        // Initialize the app
        function init() {
            setupEventListeners();
            checkClearInputButton();
        }

        function setupEventListeners() {
            elements.analyzeButton.addEventListener('click', analyzeChannel);
            elements.channelInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') analyzeChannel();
            });
            elements.channelInput.addEventListener('input', checkClearInputButton);
            elements.clearInputBtn.addEventListener('click', clearInput);
            elements.fetchMoreButton.addEventListener('click', handleFetchMore);
            elements.downloadPdfButton.addEventListener('click', generatePdf);
            
            // Video card click event (event delegation)
            elements.videoCards.addEventListener('click', (event) => {
                const videoCard = event.target.closest('.video-card');
                if (videoCard && videoCard.dataset.videoId) {
                    openVideoModal(videoCard.dataset.videoId);
                }
            });
            
            // Modal event listeners
            elements.closeModalBtn.addEventListener('click', closeVideoModal);
            elements.modalOverlay.addEventListener('click', closeVideoModal);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && elements.videoModal.classList.contains('modal-active')) {
                    closeVideoModal();
                }
            });
        }

        function checkClearInputButton() {
            elements.clearInputBtn.style.display = elements.channelInput.value.trim() ? 'block' : 'none';
        }

        function clearInput() {
            elements.channelInput.value = '';
            elements.clearInputBtn.style.display = 'none';
            elements.channelInput.focus();
        }

        function showMessage(message, type) {
            elements.messageBox.textContent = message;
            elements.messageBox.className = `message-box ${type}`;
            elements.messageBox.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(hideMessage, 5000);
            }
        }

        function hideMessage() {
            elements.messageBox.style.display = 'none';
        }

        function showLoading(show, buttonType = 'analyze') {
            if (buttonType === 'analyze') {
                elements.loadingSpinner.style.display = show ? 'block' : 'none';
                elements.analyzeButtonText.style.display = show ? 'none' : 'block';
                elements.analyzeButtonLoader.style.display = show ? 'block' : 'none';
                elements.analyzeButton.disabled = show;
            } else if (buttonType === 'fetch') {
                elements.fetchMoreButtonText.style.display = show ? 'none' : 'block';
                elements.fetchMoreButtonLoader.style.display = show ? 'block' : 'none';
                elements.fetchMoreButton.disabled = show;
            } else if (buttonType === 'pdf') {
                elements.downloadPdfButtonText.style.display = show ? 'none' : 'block';
                elements.downloadPdfButtonLoader.style.display = show ? 'block' : 'none';
                elements.downloadPdfButton.disabled = show;
            }
            
            elements.channelInput.disabled = show;
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return 'N/A';
            return Number(num).toLocaleString();
        }

        function formatDuration(duration) {
            if (!duration) return 'N/A';
            
            // Parse ISO 8601 duration format (e.g., PT1H5M30S)
            const matches = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            
            if (!matches) return duration;
            
            const hours = matches[1] ? parseInt(matches[1]) : 0;
            const minutes = matches[2] ? parseInt(matches[2]) : 0;
            const seconds = matches[3] ? parseInt(matches[3]) : 0;
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0 && hours === 0) parts.push(`${seconds}s`); // Only show seconds if no hours
            
            return parts.join(' ') || '0m';
        }

        function calculateChange(newValue, oldValue) {
            if (!oldValue || oldValue === 0) return '';
            
            const change = ((newValue - oldValue) / oldValue * 100).toFixed(2);
            if (change > 0) return `‚Üë +${change}%`;
            if (change < 0) return `‚Üì ${change}%`;
            return '';
        }

        function flash(element) {
            element.classList.add('highlight-update');
            setTimeout(() => element.classList.remove('highlight-update'), 1500);
        }

        async function getChannelId(input) {
            if (input.startsWith('UC') && input.length === 24) return input;
            
            const handleRegex = /(?:youtube\.com\/@?|@)([a-zA-Z0-9_-]+)/;
            const urlRegex = /(?:youtube\.com\/(?:channel|c|user)\/)([a-zA-Z0-9_-]+)/;
            
            let match = input.match(handleRegex) || input.match(urlRegex);
            if (!match) return null;

            const name = match[1];
            if (name.startsWith('UC') && name.length === 24) return name;

            // It's a handle or custom URL, resolve it to an ID
            showMessage('Resolving channel handle...', 'info');
            const url = `https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${name}&key=${YOUTUBE_API_KEY}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.items && data.items.length > 0) return data.items[0].id;
            } catch (error) {
                console.error('Error resolving channel name:', error);
                showMessage('Could not resolve channel handle. Please try the full channel ID/URL.', 'error');
            }
            return null;
        }

        async function analyzeChannel() {
            clearInterval(liveInterval);
            elements.subLiveIndicator.classList.add('hidden');
            elements.viewLiveIndicator.classList.add('hidden');
            hideMessage();
            elements.resultsArea.classList.add('hidden');
            elements.fetchMoreContainer.style.display = 'none';
            allVideosData = [];
            channelDataStore = {};
            previousStats = { subscriberCount: 0, viewCount: 0 };
            showLoading(true, 'analyze');

            const input = elements.channelInput.value.trim();
            if (!input) {
                showMessage('Please enter a YouTube Channel ID, URL, or @handle.', 'error');
                showLoading(false, 'analyze');
                return;
            }

            currentChannelId = await getChannelId(input);
            if (!currentChannelId) {
                if (!elements.messageBox.textContent.includes('Could not resolve')) {
                    showMessage('Invalid YouTube Channel format. Please check your input.', 'error');
                }
                showLoading(false, 'analyze');
                return;
            }

            try {
                // 1. Get Channel Details (Stats & Uploads Playlist)
                showMessage('Fetching channel details...', 'info');
                const channelUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,contentDetails,statistics,brandingSettings&id=${currentChannelId}&key=${YOUTUBE_API_KEY}`;
                const channelResponse = await fetch(channelUrl);
                
                if (!channelResponse.ok) {
                    const errorData = await channelResponse.json();
                    throw new Error(errorData.error?.message || `Failed to fetch channel details: ${channelResponse.statusText}`);
                }
                
                const channelData = await channelResponse.json();

                if (!channelData.items || channelData.items.length === 0) {
                    showMessage('Channel not found. Please check the ID/URL.', 'error');
                    showLoading(false, 'analyze');
                    return;
                }
                
                channelDataStore = channelData.items[0];
                uploadsPlaylistId = channelDataStore.contentDetails.relatedPlaylists.uploads;
                previousStats = {
                    subscriberCount: parseInt(channelDataStore.statistics.subscriberCount),
                    viewCount: parseInt(channelDataStore.statistics.viewCount)
                };

                // Fetch initial videos
                await fetchVideos(50);

            } catch (error) {
                console.error('Error fetching YouTube data:', error);
                showMessage(`An error occurred: ${error.message}. Check API key and input.`, 'error');
                showLoading(false, 'analyze');
            }
        }

        async function fetchVideos(count) {
            showLoading(true, 'fetch');
            showMessage(`Fetching ${count} videos...`, 'info');
            
            try {
                // 2. Fetch Video IDs from the uploads playlist
                let videoIds = [];
                let nextPageToken = null;
                const maxVideosToFetch = Math.min(count, 500); // Limit to 500 for API quota

                do {
                    let playlistUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=contentDetails&playlistId=${uploadsPlaylistId}&maxResults=50&key=${YOUTUBE_API_KEY}`;
                    if (nextPageToken) playlistUrl += `&pageToken=${nextPageToken}`;

                    const playlistResponse = await fetch(playlistUrl);
                    if (!playlistResponse.ok) {
                        const errorData = await playlistResponse.json();
                        throw new Error(errorData.error?.message || `Failed to fetch playlist items: ${playlistResponse.statusText}`);
                    }
                    
                    const playlistData = await playlistResponse.json();
                    
                    const ids = playlistData.items.map(item => item.contentDetails.videoId);
                    videoIds.push(...ids);
                    
                    nextPageToken = playlistData.nextPageToken;
                } while (nextPageToken && videoIds.length < maxVideosToFetch);

                videoIds = videoIds.slice(0, maxVideosToFetch);

                // 3. Fetch detailed stats for all collected video IDs in batches (max 50 per request)
                showMessage(`Fetching details for ${videoIds.length} videos...`, 'info');
                const batchSize = 50;
                allVideosData = [];
                
                for (let i = 0; i < videoIds.length; i += batchSize) {
                    const batch = videoIds.slice(i, i + batchSize);
                    const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${batch.join(',')}&key=${YOUTUBE_API_KEY}`;
                    const videoDetailsResponse = await fetch(videoDetailsUrl);
                    
                    if (!videoDetailsResponse.ok) {
                        const errorData = await videoDetailsResponse.json();
                        throw new Error(errorData.error?.message || `Failed to fetch video details: ${videoDetailsResponse.statusText}`);
                    }
                    
                    const videoDetailsData = await videoDetailsResponse.json();
                    allVideosData.push(...(videoDetailsData.items || []));
                }
                
                if (allVideosData.length === 0) {
                    showMessage('No videos found for this channel.', 'info');
                } else {
                    displayResults();
                    startLiveUpdates(currentChannelId);
                    showMessage(`Successfully analyzed ${allVideosData.length} videos. Live stats active.`, 'success');
                    elements.fetchMoreContainer.style.display = 'block';
                }

            } catch (error) {
                console.error('Error fetching videos:', error);
                showMessage(`An error occurred while fetching videos: ${error.message}`, 'error');
            } finally {
                showLoading(false, 'fetch');
            }
        }

        function displayResults() {
            // 1. Display Channel Info
            const snippet = channelDataStore.snippet;
            const branding = channelDataStore.brandingSettings || {};
            const stats = channelDataStore.statistics;
            
            elements.channelTitle.textContent = snippet.title;
            elements.channelDesc.textContent = snippet.description || '';
            
            elements.channelLogo.src = snippet.thumbnails.high?.url || snippet.thumbnails.default.url;
            elements.channelLogo.classList.remove('hidden');
            
            if (branding.image?.bannerExternalUrl) {
                elements.channelBanner.src = branding.image.bannerExternalUrl;
                elements.channelBanner.style.display = 'block';
            } else {
                elements.channelBanner.style.display = 'none';
            }

            // 2. Display Channel Stats
            elements.subscriberCount.textContent = formatNumber(stats.subscriberCount);
            elements.totalViews.textContent = formatNumber(stats.viewCount);
            elements.totalVideos.textContent = formatNumber(stats.videoCount);

            // 3. Display Extended Stats
            const created = new Date(snippet.publishedAt);
            const now = new Date();
            const years = (now - created) / (1000 * 60 * 60 * 24 * 365);
            const months = years * 12;
            
            const views = Number(stats.viewCount);
            const vids = Number(stats.videoCount);
            const avgVid = isNaN(views / vids) ? 0 : views / vids;
            const avgMonth = isNaN(views / months) ? 0 : views / months;
            const freqYear = isNaN(vids / years) ? 0 : vids / years;
            const freqMonth = isNaN(freqYear / 12) ? 0 : freqYear / 12;
            const freqWeek = isNaN(freqMonth / 4) ? 0 : freqMonth / 4;
            
            const rpmLow = 0.5;
            const rpmHigh = 20;
            const revLow = (views / 1000) * rpmLow;
            const revHigh = (views / 1000) * rpmHigh;

            elements.creationDate.textContent = created.toLocaleDateString();
            elements.channelAge.textContent = `${years.toFixed(1)} years old`;
            elements.channelLocation.textContent = snippet.country || branding.channel?.country || 'N/A';
            elements.verifiedStatus.textContent = snippet.customUrl ? 'Yes' : 'No';
            elements.isKidsContent.textContent = branding.channel?.madeForKids ? 'Yes' : 'No';
            elements.monetizationStatus.textContent = 'Yes'; // placeholder
            elements.channelCategory.textContent = snippet.categoryId || '-';
            
            // Display tags as chips
            elements.channelTags.innerHTML = '';
            if (snippet.tags && snippet.tags.length > 0) {
                snippet.tags.slice(0, 10).forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'text-xs bg-gray-100 px-2 py-1 rounded-full';
                    tagElement.textContent = tag;
                    elements.channelTags.appendChild(tagElement);
                });
                if (snippet.tags.length > 10) {
                    const moreTag = document.createElement('span');
                    moreTag.className = 'text-xs bg-gray-100 px-2 py-1 rounded-full';
                    moreTag.textContent = `+${snippet.tags.length - 10} more`;
                    elements.channelTags.appendChild(moreTag);
                }
            } else {
                const noTags = document.createElement('span');
                noTags.className = 'text-xs bg-gray-100 px-2 py-1 rounded-full';
                noTags.textContent = 'No tags';
                elements.channelTags.appendChild(noTags);
            }

            elements.avgViewsPerVideo.textContent = formatNumber(avgVid.toFixed(0));
            elements.avgViewsPerMonth.textContent = formatNumber(avgMonth.toFixed(0));
            elements.uploadFrequency.textContent = `${freqYear.toFixed(1)}/yr, ${freqMonth.toFixed(1)}/mo, ${freqWeek.toFixed(1)}/wk`;
            elements.revenueRange.textContent = `$${formatNumber(revLow.toFixed(0))} ‚Äì $${formatNumber(revHigh.toFixed(0))}`;

            // 4. Display Video Cards
            updateVideoDisplay();

            // 5. Create Graphs
            createGraphs();

            // 6. Show all results
            elements.resultsArea.classList.remove('hidden');
            elements.downloadPdfButton.style.display = 'block';
        }

        function updateVideoDisplay() {
            elements.videoCards.innerHTML = '';
            elements.videoCountDisplay.textContent = `Showing ${allVideosData.length} videos`;
            
            allVideosData.forEach(video => {
                const snippet = video.snippet;
                const stats = video.statistics;
                const contentDetails = video.contentDetails;
                
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.dataset.videoId = video.id;
                videoCard.title = snippet.title; // Tooltip for hover

                // Calculate engagement rate if views and likes are available
                const views = parseInt(stats?.viewCount || 0);
                const likes = parseInt(stats?.likeCount || 0);
                const engagementRate = views > 0 ? (likes / views * 100).toFixed(1) : 0;
                
                videoCard.innerHTML = `
                    <div class="relative">
                        <img src="${snippet.thumbnails.high?.url || snippet.thumbnails.default.url}" 
                             alt="${snippet.title}" 
                             class="video-thumbnail rounded-md w-full object-cover mb-3"
                             onerror="this.src='https://placehold.co/480x270/e0e0e0/ffffff?text=Thumbnail+Error'; this.classList.add('fallback-thumbnail')">
                        <span class="absolute bottom-3 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                            ${formatDuration(contentDetails?.duration)}
                        </span>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-2 line-clamp-2">${snippet.title}</h3>
                    <p class="text-xs text-gray-500 mb-3 flex-grow line-clamp-2">${snippet.description || 'No description'}</p>
                    <div class="text-xs text-gray-600 space-y-1 mt-auto">
                        <p><strong>Published:</strong> ${new Date(snippet.publishedAt).toLocaleDateString()}</p>
                        <div class="flex justify-between items-center pt-2 border-t mt-2">
                            <span class="tooltip">
                                üëÅÔ∏è ${formatNumber(stats?.viewCount || 0)}
                                <span class="tooltip-text">Views</span>
                            </span>
                            <span class="tooltip">
                                üëç ${formatNumber(stats?.likeCount || 0)}
                                <span class="tooltip-text">Likes (${engagementRate}% engagement)</span>
                            </span>
                            <span class="tooltip">
                                üí¨ ${formatNumber(stats?.commentCount || 0)}
                                <span class="tooltip-text">Comments</span>
                            </span>
                        </div>
                    </div>
                `;
                elements.videoCards.appendChild(videoCard);
            });
        }

        function startLiveUpdates(channelId) {
            clearInterval(liveInterval);
            
            elements.subLiveIndicator.classList.remove('hidden');
            elements.viewLiveIndicator.classList.remove('hidden');
            
            liveInterval = setInterval(async () => {
                try {
                    const url = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelId}&key=${YOUTUBE_API_KEY}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        const stats = data.items[0].statistics;
                        const newSubs = parseInt(stats.subscriberCount);
                        const newViews = parseInt(stats.viewCount);
                        
                        if (newSubs !== parseInt(elements.subscriberCount.textContent.replace(/,/g, ''))) {
                            elements.subscriberCount.textContent = formatNumber(newSubs);
                            elements.subscriberChange.textContent = calculateChange(newSubs, previousStats.subscriberCount);
                            previousStats.subscriberCount = newSubs;
                            flash(elements.subscriberCount);
                        }
                        
                        if (newViews !== parseInt(elements.totalViews.textContent.replace(/,/g, ''))) {
                            elements.totalViews.textContent = formatNumber(newViews);
                            elements.viewChange.textContent = calculateChange(newViews, previousStats.viewCount);
                            previousStats.viewCount = newViews;
                            flash(elements.totalViews);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching live stats:', error);
                }
            }, 30000); // Update every 30 seconds
        }

        function createGraphs() {
            // Destroy existing charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Graph 1: Publish Frequency (by month)
            const publishMonths = allVideosData.reduce((acc, video) => {
                const month = new Date(video.snippet.publishedAt).toLocaleString('default', { month: 'short', year: '2-digit' });
                acc[month] = (acc[month] || 0) + 1;
                return acc;
            }, {});
            
            const sortedMonths = Object.keys(publishMonths).sort((a, b) => {
                const [m1, y1] = a.split(' ');
                const [m2, y2] = b.split(' ');
                const fullY1 = parseInt(y1) < 50 ? `20${y1}` : `19${y1}`;
                const fullY2 = parseInt(y2) < 50 ? `20${y2}` : `19${y2}`;
                return new Date(`1 ${m1} ${fullY1}`) - new Date(`1 ${m2} ${fullY2}`);
            });

            const freqCtx = document.getElementById('publishFrequencyChart').getContext('2d');
            charts.publishFrequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Videos Published',
                        data: sortedMonths.map(month => publishMonths[month]),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, ticks: { precision: 0 } } 
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} video${context.parsed.y !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    }
                }
            });

            // Graph 2: Performance of last 15 videos
            const recentVideos = allVideosData.slice(0, 15).reverse();
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            charts.performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: recentVideos.map((v, i) => `Video ${15 - i}`),
                    datasets: [
                        {
                            label: 'Views',
                            data: recentVideos.map(v => v.statistics?.viewCount || 0),
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Likes',
                            data: recentVideos.map(v => v.statistics?.likeCount || 0),
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Views'
                            },
                            ticks: { precision: 0 }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Likes'
                            },
                            ticks: { precision: 0 }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return recentVideos[context[0].dataIndex].snippet.title;
                                },
                                afterLabel: function(context) {
                                    const video = recentVideos[context.dataIndex];
                                    const views = parseInt(video.statistics?.viewCount || 0);
                                    const likes = parseInt(video.statistics?.likeCount || 0);
                                    const engagement = views > 0 ? (likes / views * 100).toFixed(1) : 0;
                                    return `Engagement: ${engagement}%\nPublished: ${new Date(video.snippet.publishedAt).toLocaleDateString()}`;
                                }
                            }
                        }
                    }
                }
            });

            // Graph 3: Views vs. Engagement
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            const engagementData = allVideosData.map(video => {
                const views = parseInt(video.statistics?.viewCount || 0);
                const likes = parseInt(video.statistics?.likeCount || 0);
                const engagement = views > 0 ? (likes / views * 100) : 0;
                return {
                    x: views,
                    y: engagement,
                    title: video.snippet.title,
                    date: new Date(video.snippet.publishedAt).toLocaleDateString()
                };
            }).filter(v => v.x > 0); // Filter out videos with 0 views

            charts.engagementChart = new Chart(engagementCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Videos',
                        data: engagementData,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Views (log scale)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return Number(value).toLocaleString();
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Engagement Rate (%)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return engagementData[context[0].dataIndex].title;
                                },
                                label: function(context) {
                                    const data = engagementData[context.dataIndex];
                                    return [
                                        `Views: ${formatNumber(data.x)}`,
                                        `Engagement: ${data.y.toFixed(1)}%`,
                                        `Published: ${data.date}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function openVideoModal(videoId) {
            const video = allVideosData.find(v => v.id === videoId);
            if (!video) {
                showMessage('Video details not found.', 'error');
                return;
            }

            const snippet = video.snippet;
            const stats = video.statistics;
            const contentDetails = video.contentDetails;

            elements.modalVideoThumbnail.src = snippet.thumbnails.maxres?.url || snippet.thumbnails.high?.url || snippet.thumbnails.default.url;
            elements.modalVideoTitle.textContent = snippet.title;
            elements.modalVideoViews.textContent = formatNumber(stats?.viewCount || 0);
            elements.modalVideoLikes.textContent = formatNumber(stats?.likeCount || 0);
            elements.modalVideoComments.textContent = formatNumber(stats?.commentCount || 0);
            elements.modalVideoDuration.textContent = formatDuration(contentDetails?.duration);
            elements.modalVideoPublishedAt.textContent = new Date(snippet.publishedAt).toLocaleString();
            elements.modalVideoDescription.textContent = snippet.description || 'No description available.';
            elements.modalWatchOnYoutubeBtn.href = `https://www.youtube.com/watch?v=${videoId}`;

            document.body.classList.add('modal-open');
            elements.modalOverlay.classList.add('active');
            elements.videoModal.classList.add('modal-active');
        }

        function closeVideoModal() {
            elements.videoModal.classList.remove('modal-active');
            elements.modalOverlay.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function handleFetchMore() {
            const count = parseInt(elements.videoCountInput.value);
            if (isNaN(count) || count < 1 || count > 500) {
                showMessage('Please enter a number between 1 and 500 for video count.', 'error');
                return;
            }
            fetchVideos(count);
        }

        async function generatePdf() {
            showMessage('Generating PDF...', 'info');
            showLoading(true, 'pdf');
            
            try {
                const pdf = new jsPDF('p', 'pt', 'a4'); 
                const container = document.querySelector('.container'); 

                // Close modal if open
                closeVideoModal(); 

                // Hide elements that shouldn't be in the PDF
                const elementsToHide = [
                    elements.analyzeButton,
                    elements.downloadPdfButton,
                    elements.fetchMoreContainer,
                    elements.messageBox,
                    elements.loadingSpinner,
                    elements.clearInputBtn
                ];
                
                const originalDisplay = elementsToHide.map(el => el.style.display);
                elementsToHide.forEach(el => el.style.display = 'none');
                
                // Resize charts for PDF
                for (const chartName in charts) {
                    if (charts[chartName]) {
                        charts[chartName].resize(600, 400); // Set a fixed size for PDF
                    }
                }

                // Wait for charts to resize
                await new Promise(resolve => setTimeout(resolve, 500));

                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: -window.scrollY
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0); 
                const imgWidth = 595.28; // A4 width in points
                const pageHeight = 841.89; // A4 height in points
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add additional pages if content is longer than one page
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Add metadata
                const title = `${elements.channelTitle.textContent || 'YouTube_Channel'} Report`;
                pdf.setProperties({
                    title: title,
                    subject: 'YouTube Channel Analytics Report',
                    author: 'YouTube Dashboard'
                });

                pdf.save(`${title}.pdf`);
                showMessage('PDF generated successfully!', 'success');

            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage(`Failed to generate PDF: ${error.message}`, 'error');
            } finally {
                // Restore hidden elements
                const elementsToHide = [
                    elements.analyzeButton,
                    elements.downloadPdfButton,
                    elements.fetchMoreContainer,
                    elements.messageBox,
                    elements.loadingSpinner,
                    elements.clearInputBtn
                ];
                
                elementsToHide.forEach((el, i) => {
                    el.style.display = originalDisplay[i];
                });
                
                // Restore chart sizes
                for (const chartName in charts) {
                    if (charts[chartName]) {
                        charts[chartName].resize();
                    }
                }
                
                showLoading(false, 'pdf');
            }
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
